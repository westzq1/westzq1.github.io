---
layout: post
title: Oracle - CROSSCHECK reports "Failed to load Media Management Library"
modified: 2019-03-02
categories: [Oracle]
tags: 
  - Oracle.Recovery
comments: true
---

The RMAN CROSSCHECK of one database is not working.<br/>
We do CROSSCHECK on a backupset: 
<pre class="prettyprint lang-sql linenums=1 ">
RMAN> CROSSCHECK BACKUPSET 368551645;

RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of crosscheck command at 03/01/2019 15:26:57
ORA-19554: error allocating device, device type: SBT_TAPE, device name: 
ORA-27211: Failed to load Media Management Library
Additional information: 2
</pre>

But this backupset is not on the TAPE, it is actually on the disk
<pre class="prettyprint lang-sql linenums=1 ">
RMAN> list backupset 368551645;


List of Backup Sets
===================


BS Key  Type LV Size       Device Type Elapsed Time Completion Time
------- ---- -- ---------- ----------- ------------ ---------------
368551645 Incr 0  9.51G      DISK        00:31:00     01-APR-16      
        BP Key: 368551673   Status: AVAILABLE  Compressed: NO  Tag: BACKUP_LEVEL0_MONTHLY
        Piece Name: /oraclebackup/rman/ddm/XXXX/backup_XXXX_set166662_piece1_20160401_o6r1vf6r_1_1.bus
        Keep: LOGS               Until: 09-MAY-17      
  List of Datafiles in backup set 368551645
  File LV Type Ckp SCN    Ckp Time  Name
  ---- -- ---- ---------- --------- ----
  6    0  Incr 111595502331 01-APR-16 /data01/xxxx06/app/oracle/oradata/XXXX/sysaux_XXXX_01.dbf
  27   0  Incr 111595502331 01-APR-16 /data01/xxxx06/app/oracle/oradata/XXXX/indx_XXXX_01.dbf
  70   0  Incr 111595502331 01-APR-16 /data01/xxxx07/app/oracle/oradata/XXXX/emdata_XXXX_01.dbf
  71   0  Incr 111595502331 01-APR-16 /data01/xxxx07/app/oracle/oradata/XXXX/undo_XXXX_19.dbf 
  73   0  Incr 111595502331 01-APR-16 /data01/xxxx07/app/oracle/oradata/XXXX/development_XXXX_51.dbf
  118  0  Incr 111595502331 01-APR-16 /data01/xxxx06/app/oracle/oradata/XXXX/undo_XXXX_08.dbf
  206  0  Incr 111595502331 01-APR-16 /data01/xxxx06/app/oracle/oradata/XXXX/scratchdata_XXXX_01.dbf
  207  0  Incr 111595502331 01-APR-16 /data01/xxxx06/app/oracle/oradata/XXXX/scratchdata_XXXX_02.dbf
  236  0  Incr 111595502331 01-APR-16 /data01/xxxx08/app/oracle/oradata/XXXX/undo_XXXX_23.dbf
  237  0  Incr 111595502331 01-APR-16 /data01/xxxx08/app/oracle/oradata/XXXX/undo_XXXX_24.dbf
</pre>

This is because we used TAPE for backup many years ago, and there are some configurations of TAPE still in RMAN, and they didn't remove it.
<pre class="prettyprint lang-sql linenums=1 ">
RMAN> show all;

RMAN configuration parameters for database with db_unique_name XXXX are:
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 365 DAYS;
CONFIGURE BACKUP OPTIMIZATION ON;
CONFIGURE DEFAULT DEVICE TYPE TO DISK;
CONFIGURE CONTROLFILE AUTOBACKUP ON;
--
CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE 'SBT_TAPE' TO '%F%d';
CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '/oraclebackup/rman/control/%d/control_%D_%T_%F';
--
CONFIGURE DEVICE TYPE 'SBT_TAPE' PARALLELISM 2 BACKUP TYPE TO BACKUPSET;
CONFIGURE DEVICE TYPE DISK PARALLELISM 2 BACKUP TYPE TO BACKUPSET;
--
CONFIGURE DATAFILE BACKUP COPIES FOR DEVICE TYPE 'SBT_TAPE' TO 1;
CONFIGURE DATAFILE BACKUP COPIES FOR DEVICE TYPE DISK TO 1;
--
CONFIGURE ARCHIVELOG BACKUP COPIES FOR DEVICE TYPE 'SBT_TAPE' TO 1;
CONFIGURE ARCHIVELOG BACKUP COPIES FOR DEVICE TYPE DISK TO 2;
CONFIGURE CHANNEL DEVICE TYPE DISK FORMAT   '/oraclebackup/rman/ddw/%d/backup_%d_set%s_piece%p_%T_%U.bus';
CONFIGURE MAXSETSIZE TO UNLIMITED;
CONFIGURE ENCRYPTION FOR DATABASE OFF;
CONFIGURE ENCRYPTION ALGORITHM 'AES128';
CONFIGURE COMPRESSION ALGORITHM 'BASIC' AS OF RELEASE 'DEFAULT' OPTIMIZE FOR LOAD TRUE ; # default
CONFIGURE RMAN OUTPUT TO KEEP FOR 7 DAYS; # default
CONFIGURE ARCHIVELOG DELETION POLICY TO NONE;
CONFIGURE SNAPSHOT CONTROLFILE NAME TO '/l01/app/oracle/product/12.1.0.2/dbs/snapcf_XXXX.f'; # default
</pre>

Actually, this script had been not working for a long time, but no one check it.<br/>
So, the solution is to clear the configuration of TAPE.
<pre class="prettyprint lang-sql linenums=1 ">
RMAN> CONFIGURE DEVICE TYPE 'SBT_TAPE' clear;
RMAN> CONFIGURE CHANNEL DEVICE TYPE 'SBT_TAPE' clear;
</pre>

After clear:
<pre class="prettyprint lang-sql linenums=1 ">
RMAN> CROSSCHECK BACKUPSET 368551645; 

allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=3273 device type=DISK
allocated channel: ORA_DISK_2
channel ORA_DISK_2: SID=3600 device type=DISK
crosschecked backup piece: found to be 'EXPIRED'
backup piece handle=/oraclebackup/rman/ddm/XXXX/backup_XXXX_set166662_piece1_20160401_o6r1vf6r_1_1.bus RECID=234591 STAMP=908049630
Crosschecked 1 objects
</pre>
